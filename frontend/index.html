<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Telegram Calendar Mini App</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
  <style>
    body { font-family: Arial, sans-serif; padding: 10px; max-width: 600px; margin: auto; }
    input, select, button { display: block; margin: 5px 0; padding: 6px; width: 100%; box-sizing: border-box; }
    label { font-weight: bold; margin-top: 10px; }
    #repeat-options { margin-top: 5px; }
    .days-checkboxes label { display: inline-block; margin-right: 5px; font-weight: normal; }
    #calendar { margin-top: 20px; }
  </style>
</head>
<body>
  <h1>–ö–∞–ª–µ–Ω–¥–∞—Ä—å —Å–æ–±—ã—Ç–∏–π</h1>

  <label>–ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è</label>
  <input type="text" id="event-name" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ">

  <label>–î–∞—Ç–∞</label>
  <input type="date" id="event-date">

  <label>–í—Ä–µ–º—è</label>
  <input type="time" id="event-time">

  <label><input type="checkbox" id="repeat-event"> –ü–æ–≤—Ç–æ—Ä—è–µ–º–æ–µ —Å–æ–±—ã—Ç–∏–µ</label>

  <div id="repeat-options" style="display:none;">
    <label>–í—ã–±–µ—Ä–∏—Ç–µ –¥–Ω–∏ –Ω–µ–¥–µ–ª–∏:</label>
    <div class="days-checkboxes">
      <label><input type="checkbox" value="1">–ü–Ω</label>
      <label><input type="checkbox" value="2">–í—Ç</label>
      <label><input type="checkbox" value="3">–°—Ä</label>
      <label><input type="checkbox" value="4">–ß—Ç</label>
      <label><input type="checkbox" value="5">–ü—Ç</label>
      <label><input type="checkbox" value="6">–°–±</label>
      <label><input type="checkbox" value="0">–í—Å</label>
    </div>
  </div>

  <button id="save-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ</button>

  <div id="calendar"></div>

  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();

    const repeatCheckbox = document.getElementById('repeat-event');
    const repeatOptions = document.getElementById('repeat-options');
    const saveBtn = document.getElementById('save-btn');
    const calendarEl = document.getElementById('calendar');

    let events = [];

    repeatCheckbox.addEventListener('change', () => {
      repeatOptions.style.display = repeatCheckbox.checked ? 'block' : 'none';
    });

    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      editable: true,
      selectable: true,
      events: [],
      eventClick: function(info) {
        if (confirm(`–£–¥–∞–ª–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ "${info.event.title}"?`)) {
          info.event.remove();
          events = events.filter(e => e.id !== info.event.id);
        }
      }
    });
    calendar.render();

    function addEventToCalendar(ev) {
      let eventData = {
        id: String(events.length + 1),
        title: ev.name + (ev.repeat ? ' üîÅ' : ''),
        start: `${ev.date}T${ev.time}`,
        allDay: false,
        backgroundColor: ev.repeat ? '#007bff' : '#28a745'
      };
      calendar.addEvent(eventData);
    }

    saveBtn.addEventListener('click', () => {
      const name = document.getElementById('event-name').value.trim();
      const date = document.getElementById('event-date').value;
      const time = document.getElementById('event-time').value;
      const repeat = repeatCheckbox.checked;
      const days = Array.from(document.querySelectorAll('.days-checkboxes input:checked')).map(d => Number(d.value));

      if (!name || !date || !time) {
        alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!');
        return;
      }

      const event = { name, date, time, repeat, days, id: events.length + 1 };
      events.push(event);
      addEventToCalendar(event);

      // –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ –±—ç–∫–µ–Ω–¥
      fetch('/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(event)
      }).then(res => res.json())
        .then(() => {
          tg.sendData(JSON.stringify(event));
        });

      // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
      document.getElementById('event-name').value = '';
      document.getElementById('event-date').value = '';
      document.getElementById('event-time').value = '';
      repeatCheckbox.checked = false;
      repeatOptions.style.display = 'none';
      document.querySelectorAll('.days-checkboxes input').forEach(d => d.checked = false);
    });
  </script>
</body>
</html>
